<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Model — SIE Model Viewer</title>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
  }
}
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-tertiary: #1a2236;
  --bg-elevated: #1e293b;
  --bg-hover: #243044;
  --border: #2a3a52;
  --border-light: #334766;
  --text-primary: #e8edf5;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent: #3b82f6;
  --accent-hover: #2563eb;
  --accent-glow: rgba(59, 130, 246, 0.15);
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #06b6d4;
  --font-body: 'DM Sans', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius: 6px;
}
html, body {
  height: 100%; font-family: var(--font-body);
  background: var(--bg-primary); color: var(--text-primary); font-size: 14px;
}
body { display: flex; flex-direction: column; }

.topbar {
  height: 56px; display: flex; align-items: center;
  padding: 0 24px; gap: 16px;
  background: var(--bg-secondary); border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.topbar .brand {
  font-weight: 700; font-size: 16px; letter-spacing: -0.3px;
  background: linear-gradient(135deg, var(--accent), var(--info));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none;
}
.topbar-logo { height: 38px; object-fit: contain; }
.topbar .spacer { flex: 1; }
.back-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 14px; border-radius: var(--radius);
  background: var(--bg-tertiary); border: 1px solid var(--border);
  color: var(--text-secondary); font-size: 13px;
  font-family: var(--font-body); cursor: pointer; text-decoration: none; transition: all .15s;
}
.back-btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-light); }

.main { flex: 1; display: flex; overflow: hidden; }
.upload-panel {
  width: 480px; flex-shrink: 0; display: flex; flex-direction: column;
  border-right: 1px solid var(--border); background: var(--bg-secondary); overflow-y: auto;
}
.upload-panel::-webkit-scrollbar { width: 5px; }
.upload-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.preview-panel { flex: 1; position: relative; background: #0d1117; }
#preview-canvas { width: 100%; height: 100%; display: block; }

.panel-section { padding: 24px; border-bottom: 1px solid var(--border); }
.panel-section:last-child { border-bottom: none; }
.section-title {
  font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.7px; color: var(--text-muted); margin-bottom: 16px;
}
.section-title-lg { font-size: 18px; font-weight: 600; margin-bottom: 6px; }
.section-subtitle { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; }

.upload-zone {
  border: 2px dashed var(--border-light); border-radius: 12px;
  padding: 48px 24px; text-align: center; cursor: pointer;
  transition: all .25s; background: var(--bg-tertiary);
}
.upload-zone:hover, .upload-zone.dragover {
  border-color: var(--accent); background: var(--accent-glow); transform: scale(1.01);
}
.upload-zone.has-file {
  border-color: var(--success); border-style: solid; background: rgba(16,185,129,0.05);
}
.upload-icon {
  width: 64px; height: 64px; margin: 0 auto 16px; border-radius: 16px;
  background: var(--accent-glow); display: flex; align-items: center; justify-content: center;
}
.upload-zone h3 { font-size: 15px; font-weight: 500; margin-bottom: 8px; }
.upload-zone p { font-size: 12px; color: var(--text-muted); line-height: 1.5; }

.format-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px; }
.format-card {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 8px;
  background: var(--bg-tertiary); border: 1px solid var(--border); transition: all .15s;
}
.format-card:hover { border-color: var(--border-light); }
.format-card .ext {
  font-size: 11px; font-weight: 700; font-family: var(--font-mono);
  padding: 3px 8px; border-radius: 4px; text-transform: uppercase; min-width: 40px; text-align: center;
}
.format-card .ext.native { background: rgba(16,185,129,0.15); color: var(--success); }
.format-card .ext.convert { background: rgba(245,158,11,0.15); color: var(--warning); }
.format-card .format-info { font-size: 11px; color: var(--text-secondary); line-height: 1.3; }
.format-card .format-label { font-size: 12px; font-weight: 500; color: var(--text-primary); }

.file-card {
  display: flex; align-items: center; gap: 14px;
  padding: 16px; border-radius: 10px;
  background: var(--bg-tertiary); border: 1px solid var(--border); margin-top: 16px;
}
.file-card.hidden { display: none; }
.file-icon {
  width: 52px; height: 52px; border-radius: 10px; background: rgba(59,130,246,0.12);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 700; font-family: var(--font-mono); color: var(--accent); flex-shrink: 0;
}
.file-icon.ifc { background: rgba(16,185,129,0.12); color: var(--success); }
.file-icon.rvt { background: rgba(245,158,11,0.12); color: var(--warning); }
.file-meta { flex: 1; min-width: 0; }
.file-meta h4 { font-size: 13px; font-weight: 500; margin-bottom: 3px; word-break: break-all; }
.file-meta p { font-size: 11px; color: var(--text-muted); }
.file-remove {
  width: 32px; height: 32px; border: none; background: rgba(239,68,68,0.1);
  color: var(--danger); border-radius: 8px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all .15s;
}
.file-remove:hover { background: rgba(239,68,68,0.2); }

.progress-section { margin-top: 20px; }
.progress-section.hidden { display: none; }
.progress-bar { height: 8px; background: var(--bg-hover); border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--accent); border-radius: 4px; width: 0%; transition: width .3s ease; }
.progress-fill.error { background: var(--danger); }
.progress-fill.done { background: var(--success); }
.progress-info { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-top: 8px; }
.progress-steps { margin-top: 14px; }
.step-item { display: flex; align-items: center; gap: 10px; padding: 6px 0; font-size: 12px; color: var(--text-muted); }
.step-item.active { color: var(--accent); }
.step-item.done { color: var(--success); }
.step-item.error { color: var(--danger); }
.step-dot {
  width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 10px;
}
.step-item.active .step-dot { border-color: var(--accent); background: var(--accent-glow); }
.step-item.done .step-dot { border-color: var(--success); background: rgba(16,185,129,0.15); }
.step-item.error .step-dot { border-color: var(--danger); background: rgba(239,68,68,0.15); }

.btn-process {
  width: 100%; padding: 14px; border: none; margin-top: 20px;
  background: var(--accent); color: #fff; font-size: 14px;
  font-weight: 600; font-family: var(--font-body);
  border-radius: 8px; cursor: pointer; transition: all .2s;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.btn-process:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-1px); }
.btn-process:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

.preview-empty {
  position: absolute; inset: 0; display: flex; flex-direction: column;
  align-items: center; justify-content: center; color: var(--text-muted); text-align: center; gap: 12px;
}
.preview-empty.hidden { display: none; }
.preview-empty svg { opacity: 0.2; }
.preview-empty h3 { font-size: 15px; font-weight: 500; }
.preview-empty p { font-size: 12px; max-width: 280px; }
.preview-stats {
  position: absolute; bottom: 16px; left: 16px; font-size: 11px; color: var(--text-muted);
  font-family: var(--font-mono); display: flex; gap: 12px; pointer-events: none;
}
.preview-stats span { padding: 5px 10px; background: rgba(0,0,0,0.6); border-radius: 4px; backdrop-filter: blur(4px); }
.preview-stats.hidden { display: none; }

.rvt-help {
  padding: 16px; border-radius: 10px; margin-top: 16px;
  background: rgba(245,158,11,0.06); border: 1px solid rgba(245,158,11,0.2);
}
.rvt-help h4 { font-size: 13px; font-weight: 600; color: var(--warning); margin-bottom: 10px; }
.rvt-help ol { margin-left: 18px; font-size: 12px; color: var(--text-secondary); line-height: 1.8; }
.rvt-help a { color: var(--accent); }
.rvt-help .opt-label { font-weight: 600; color: var(--text-primary); }
.rvt-help.hidden { display: none; }

.option-row {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 0; font-size: 13px; color: var(--text-secondary); cursor: pointer;
}
.option-row input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; }

.toast-container { position: fixed; top: 68px; right: 20px; z-index: 9000; display: flex; flex-direction: column; gap: 8px; }
.toast {
  padding: 12px 18px; border-radius: var(--radius); background: var(--bg-secondary);
  border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  font-size: 13px; display: flex; align-items: center; gap: 10px;
  animation: slideIn .3s ease; max-width: 360px;
}
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } }
.toast.success { border-left: 3px solid var(--success); }
.toast.warning { border-left: 3px solid var(--warning); }
.toast.info { border-left: 3px solid var(--accent); }

@media (max-width: 900px) {
  .main { flex-direction: column; }
  .upload-panel { width: 100%; max-height: 50vh; border-right: none; border-bottom: 1px solid var(--border); }
}
</style>
</head>
<body>

<div class="topbar">
  <a href="index.html" class="brand">SIE Model Viewer</a>
  <img src="Logo.png" alt="Smarter Ideas Engineering Services" class="topbar-logo">
  <span class="spacer"></span>
  <a href="index.html" class="back-btn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
    Back to Viewer
  </a>
</div>

<div class="main">
  <div class="upload-panel">
    <div class="panel-section">
      <div class="section-title-lg">Upload Model</div>
      <div class="section-subtitle">Load a 3D model to view, inspect, and collaborate on.</div>

      <div class="upload-zone" id="upload-zone">
        <div class="upload-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
        </div>
        <h3>Drop your model file here</h3>
        <p>or click to browse your computer</p>
      </div>
      <input type="file" id="file-input" style="display:none" accept=".ifc,.obj,.stl,.gltf,.glb,.fbx,.dae,.ply,.rvt">

      <div class="file-card hidden" id="file-card">
        <div class="file-icon" id="file-icon">IFC</div>
        <div class="file-meta">
          <h4 id="file-name">model.ifc</h4>
          <p id="file-size">24.5 MB</p>
        </div>
        <button class="file-remove" id="btn-clear">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>

      <div class="rvt-help hidden" id="rvt-help">
        <h4>&#9888; Revit files need conversion before viewing</h4>
        <ol>
          <li><span class="opt-label">Option A — Export as IFC:</span><br>
            In Revit: File &rarr; Export &rarr; IFC, then upload the .ifc file here.</li>
          <li><span class="opt-label">Option B — Export as GLB:</span><br>
            Use Revit 2023+ built-in glTF export, or the free
            <a href="https://apps.autodesk.com/RVT/en/Detail/Index?id=6193770166503453647" target="_blank">glTF Exporter plugin</a>.</li>
          <li><span class="opt-label">Option C — Autodesk Platform Services:</span><br>
            Use the <a href="https://aps.autodesk.com/en/docs/model-derivative/v2/tutorials/translate-source-file-to-svf2/" target="_blank">Model Derivative API</a>
            for server-side .rvt &rarr; SVF2 conversion.</li>
        </ol>
      </div>

      <div class="progress-section hidden" id="progress-section">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <div class="progress-info">
          <span id="progress-label">Waiting...</span>
          <span id="progress-pct">0%</span>
        </div>
        <div class="progress-steps" id="progress-steps"></div>
      </div>

      <button class="btn-process" id="btn-process" disabled>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="5 3 19 12 5 21 5 3"/>
        </svg>
        Load &amp; Preview Model
      </button>
    </div>

    <div class="panel-section">
      <div class="section-title">Options</div>
      <label class="option-row"><input type="checkbox" id="opt-center" checked> Auto-centre and scale to fit</label>
      <label class="option-row"><input type="checkbox" id="opt-shadows" checked> Enable shadows</label>
    </div>

    <div class="panel-section">
      <div class="section-title">Supported Formats</div>
      <div class="format-grid">
        <div class="format-card"><span class="ext native">IFC</span><div><div class="format-label">IFC 2x3 / 4</div><div class="format-info">Industry Foundation Classes</div></div></div>
        <div class="format-card"><span class="ext native">GLB</span><div><div class="format-label">glTF Binary</div><div class="format-info">Recommended for web</div></div></div>
        <div class="format-card"><span class="ext native">OBJ</span><div><div class="format-label">Wavefront OBJ</div><div class="format-info">Universal mesh format</div></div></div>
        <div class="format-card"><span class="ext native">FBX</span><div><div class="format-label">Autodesk FBX</div><div class="format-info">Autodesk exchange</div></div></div>
        <div class="format-card"><span class="ext native">STL</span><div><div class="format-label">Stereolithography</div><div class="format-info">3D printing / mesh</div></div></div>
        <div class="format-card"><span class="ext native">DAE</span><div><div class="format-label">Collada</div><div class="format-info">XML-based 3D</div></div></div>
        <div class="format-card"><span class="ext native">PLY</span><div><div class="format-label">Polygon File</div><div class="format-info">Point cloud / scan</div></div></div>
        <div class="format-card"><span class="ext convert">RVT</span><div><div class="format-label">Revit</div><div class="format-info">Needs export first</div></div></div>
      </div>
    </div>
  </div>

  <div class="preview-panel">
    <canvas id="preview-canvas"></canvas>
    <div class="preview-empty" id="preview-empty">
      <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 002 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0022 16z"/>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
        <line x1="12" y1="22.08" x2="12" y2="12"/>
      </svg>
      <h3>3D Preview</h3>
      <p>Upload a model file to see a live preview here. Supports orbit, zoom, and pan.</p>
    </div>
    <div class="preview-stats hidden" id="preview-stats">
      <span id="stat-elements">0 elements</span>
      <span id="stat-format">—</span>
      <span id="stat-fps">0 FPS</span>
    </div>
  </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
(function() {
  var selectedFile = null;
  var SUPPORTED = ['ifc','obj','stl','gltf','glb','fbx','dae','ply','rvt'];

  function el(id) { return document.getElementById(id); }
  function fileExt(name) { return name.split('.').pop().toLowerCase(); }
  function fmtSize(b) {
    if (b < 1024) return b + ' B';
    if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
    return (b / 1048576).toFixed(1) + ' MB';
  }

  window._getFile = function() { return selectedFile; };

  function showFile(file) {
    selectedFile = file;
    var e = fileExt(file.name);
    el('file-card').classList.remove('hidden');
    el('file-icon').textContent = e.toUpperCase();
    el('file-icon').className = 'file-icon' + (e === 'ifc' ? ' ifc' : e === 'rvt' ? ' rvt' : '');
    el('file-name').textContent = file.name;
    el('file-size').textContent = fmtSize(file.size);
    el('upload-zone').classList.add('has-file');
    el('btn-process').disabled = false;
    if (e === 'rvt') {
      el('rvt-help').classList.remove('hidden');
      el('btn-process').disabled = true;
    } else {
      el('rvt-help').classList.add('hidden');
    }
    el('progress-section').classList.add('hidden');
    el('progress-fill').style.width = '0%';
    el('progress-fill').className = 'progress-fill';
  }

  function clearFile() {
    selectedFile = null;
    el('file-input').value = '';
    el('file-card').classList.add('hidden');
    el('upload-zone').classList.remove('has-file');
    el('btn-process').disabled = true;
    el('progress-section').classList.add('hidden');
    el('rvt-help').classList.add('hidden');
  }

  window.showToast = function(msg, type) {
    var c = el('toast-container');
    var t = document.createElement('div');
    t.className = 'toast ' + (type || 'info');
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(function() { t.style.opacity = '0'; t.style.transition = 'opacity .3s'; }, 3000);
    setTimeout(function() { t.remove(); }, 3500);
  };

  el('upload-zone').addEventListener('click', function() { el('file-input').click(); });
  el('file-input').addEventListener('change', function(e) { if (e.target.files[0]) showFile(e.target.files[0]); });
  el('btn-clear').addEventListener('click', function() { clearFile(); });
  el('btn-process').addEventListener('click', function() {
    if (window.processModel) window.processModel();
    else alert('3D engine is still loading. Please wait a moment and try again.');
  });

  var zone = el('upload-zone');
  zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', function() { zone.classList.remove('dragover'); });
  zone.addEventListener('drop', function(e) {
    e.preventDefault(); zone.classList.remove('dragover');
    if (e.dataTransfer.files[0]) showFile(e.dataTransfer.files[0]);
  });
})();
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

var scene, camera, renderer, controls;
var frameCount = 0, lastFpsTime = 0;

function initPreview() {
  var canvas = document.getElementById('preview-canvas');
  var container = canvas.parentElement;
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0d1117);
  camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 2000);
  camera.position.set(40, 30, 50);
  renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.1;
  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.08;

  scene.add(new THREE.AmbientLight(0x8899bb, 0.7));
  var dir = new THREE.DirectionalLight(0xffeedd, 1.6);
  dir.position.set(40, 80, 50); dir.castShadow = true; dir.shadow.mapSize.set(2048, 2048);
  scene.add(dir);
  var fill = new THREE.DirectionalLight(0xaabbff, 0.4);
  fill.position.set(-30, 40, -40); scene.add(fill);
  scene.add(new THREE.HemisphereLight(0x88aacc, 0x445566, 0.3));

  var ground = new THREE.Mesh(
    new THREE.PlaneGeometry(400, 400),
    new THREE.MeshStandardMaterial({ color: 0x1a1f2e, roughness: 0.95 })
  );
  ground.rotation.x = -Math.PI / 2; ground.receiveShadow = true; scene.add(ground);
  scene.add(new THREE.GridHelper(200, 40, 0x2a3a52, 0x1a2236));

  window.addEventListener('resize', function() {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  });
  animate();
}

function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
  frameCount++;
  var now = performance.now();
  if (now - lastFpsTime >= 1000) {
    var fpsEl = document.getElementById('stat-fps');
    if (fpsEl) fpsEl.textContent = frameCount + ' FPS';
    frameCount = 0; lastFpsTime = now;
  }
}

async function getLoader(ext) {
  switch (ext) {
    case 'obj': { var m = await import('three/addons/loaders/OBJLoader.js'); return new m.OBJLoader(); }
    case 'stl': { var m = await import('three/addons/loaders/STLLoader.js'); return new m.STLLoader(); }
    case 'gltf': case 'glb': { var m = await import('three/addons/loaders/GLTFLoader.js'); return new m.GLTFLoader(); }
    case 'fbx': { var m = await import('three/addons/loaders/FBXLoader.js'); return new m.FBXLoader(); }
    case 'dae': { var m = await import('three/addons/loaders/ColladaLoader.js'); return new m.ColladaLoader(); }
    case 'ply': { var m = await import('three/addons/loaders/PLYLoader.js'); return new m.PLYLoader(); }
  }
  return null;
}

function setProgress(pct, label) {
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-pct').textContent = Math.round(pct) + '%';
  if (label) document.getElementById('progress-label').textContent = label;
}
function addStep(text, status) {
  var icons = { active: '\u25C9', done: '\u2713', error: '\u2717', pending: '\u25CB' };
  var div = document.createElement('div');
  div.className = 'step-item ' + status;
  div.innerHTML = '<span class="step-dot">' + (icons[status] || '\u25CB') + '</span>' + text;
  document.getElementById('progress-steps').appendChild(div);
  return div;
}
function updateStep(div, status) {
  var icons = { active: '\u25C9', done: '\u2713', error: '\u2717' };
  div.className = 'step-item ' + status;
  div.querySelector('.step-dot').textContent = icons[status] || '\u25CB';
}

window.processModel = async function() {
  var file = window._getFile();
  if (!file) return;
  var ext = file.name.split('.').pop().toLowerCase();
  var prog = document.getElementById('progress-section');
  var fill = document.getElementById('progress-fill');
  var btn = document.getElementById('btn-process');
  var steps = document.getElementById('progress-steps');
  prog.classList.remove('hidden');
  fill.className = 'progress-fill';
  steps.innerHTML = '';
  btn.disabled = true;

  try {
    if (ext === 'ifc') {
      var s1 = addStep('Loading IFC engine (web-ifc)...', 'active');
      setProgress(5, 'Loading IFC engine...');
      await new Promise(function(resolve, reject) {
        if (window.WebIFC) { resolve(); return; }
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/web-ifc@0.0.57/web-ifc-api-iife.js';
        s.onload = function() { setTimeout(resolve, 300); };
        s.onerror = function() { reject(new Error('Failed to download web-ifc')); };
        document.head.appendChild(s);
      });
      updateStep(s1, 'done');
      var s2 = addStep('Initialising IFC parser...', 'active');
      setProgress(15, 'Initialising...');
      var api = new window.WebIFC.IfcAPI();
      api.SetWasmPath('https://cdn.jsdelivr.net/npm/web-ifc@0.0.57/');
      await api.Init();
      updateStep(s2, 'done');
      var s3 = addStep('Reading IFC file...', 'active');
      setProgress(25, 'Reading file...');
      var buf = await file.arrayBuffer();
      var modelID = api.OpenModel(new Uint8Array(buf));
      updateStep(s3, 'done');
      var s4 = addStep('Extracting geometry...', 'active');
      setProgress(35, 'Extracting geometry...');

      var group = new THREE.Group();
      group.name = file.name;
      var matMap = {
        WALL: new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.8 }),
        SLAB: new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.85 }),
        FOOTING: new THREE.MeshStandardMaterial({ color: 0x999999, roughness: 0.9 }),
        WINDOW: new THREE.MeshPhysicalMaterial({ color: 0x88bbdd, roughness: 0.05, transmission: 0.5, transparent: true, opacity: 0.6 }),
        DOOR: new THREE.MeshStandardMaterial({ color: 0x8B7355, roughness: 0.7 }),
        COLUMN: new THREE.MeshStandardMaterial({ color: 0x999999, roughness: 0.7, metalness: 0.1 }),
        BEAM: new THREE.MeshStandardMaterial({ color: 0xb0b0b0, roughness: 0.6, metalness: 0.15 }),
        ROOF: new THREE.MeshStandardMaterial({ color: 0x777788, roughness: 0.8 }),
        STAIR: new THREE.MeshStandardMaterial({ color: 0xbbbbbb, roughness: 0.7 }),
        RAILING: new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.3, metalness: 0.6 }),
        PIPE: new THREE.MeshStandardMaterial({ color: 0x66aa88, roughness: 0.4, metalness: 0.3 }),
        DUCT: new THREE.MeshStandardMaterial({ color: 0x8899aa, roughness: 0.5, metalness: 0.4 }),
        FURNISH: new THREE.MeshStandardMaterial({ color: 0xbb9966, roughness: 0.7 }),
        DEFAULT: new THREE.MeshStandardMaterial({ color: 0xaabbcc, roughness: 0.6, metalness: 0.1, side: THREE.DoubleSide })
      };
      function pickMat(typeStr) {
        var t = (typeStr || '').toUpperCase();
        for (var key in matMap) { if (key !== 'DEFAULT' && t.indexOf(key) !== -1) return matMap[key]; }
        return matMap.DEFAULT;
      }

      var flatMeshes = api.LoadAllGeometry(modelID);
      var total = flatMeshes.size();
      for (var i = 0; i < total; i++) {
        var fm = flatMeshes.get(i);
        var ifcType = '';
        try { var ld = api.GetLine(modelID, fm.expressID); if (ld && ld.constructor) ifcType = ld.constructor.name || ''; } catch(ignore) {}
        var geoms = fm.geometries;
        for (var j = 0; j < geoms.size(); j++) {
          var pg = geoms.get(j);
          var gd = api.GetGeometry(modelID, pg.geometryExpressID);
          var verts = api.GetVertexArray(gd.GetVertexData(), gd.GetVertexDataSize());
          var idx = api.GetIndexArray(gd.GetIndexData(), gd.GetIndexDataSize());
          if (!verts.length || !idx.length) continue;
          var posArr = new Float32Array(verts.length / 2);
          var normArr = new Float32Array(verts.length / 2);
          for (var k = 0; k < verts.length; k += 6) {
            var vi = k / 6;
            posArr[vi*3]=verts[k]; posArr[vi*3+1]=verts[k+1]; posArr[vi*3+2]=verts[k+2];
            normArr[vi*3]=verts[k+3]; normArr[vi*3+1]=verts[k+4]; normArr[vi*3+2]=verts[k+5];
          }
          var bg = new THREE.BufferGeometry();
          bg.setAttribute('position', new THREE.BufferAttribute(posArr, 3));
          bg.setAttribute('normal', new THREE.BufferAttribute(normArr, 3));
          bg.setIndex(new THREE.BufferAttribute(idx, 1));
          var mat = pickMat(ifcType).clone();
          var c = pg.color;
          if (c && (c.x||c.y||c.z)) { mat.color.setRGB(c.x,c.y,c.z); if(c.w<0.95){mat.transparent=true;mat.opacity=c.w;} }
          var mesh = new THREE.Mesh(bg, mat);
          var mtx = new THREE.Matrix4(); mtx.fromArray(pg.flatTransformation); mesh.applyMatrix4(mtx);
          mesh.name = ifcType || ('Element_'+fm.expressID);
          group.add(mesh);
        }
        if (i%50===0) { setProgress(35+(i/total)*50,'Processing '+(i+1)+' / '+total+'...'); await new Promise(function(r){setTimeout(r,0);}); }
      }
      updateStep(s4, 'done');
      var s5 = addStep('Rendering preview...', 'active');
      setProgress(90, 'Rendering...');
      addToScene(group, file.name);
      updateStep(s5, 'done');
      setProgress(100, 'Complete');
      fill.classList.add('done');
      window.showToast('IFC model loaded — ' + group.children.length + ' elements', 'success');

    } else {
      var s1b = addStep('Loading '+ext.toUpperCase()+' parser...', 'active');
      setProgress(10, 'Loading parser...');
      var loader = await getLoader(ext);
      if (!loader) throw new Error('No parser for .'+ext);
      updateStep(s1b, 'done');
      var s2b = addStep('Reading file...', 'active');
      setProgress(25, 'Reading file...');
      var data = await file.arrayBuffer();
      var textData = (['obj','dae','gltf'].indexOf(ext)!==-1) ? new TextDecoder().decode(data) : null;
      updateStep(s2b, 'done');
      var s3b = addStep('Parsing geometry...', 'active');
      setProgress(50, 'Parsing...');
      var parsed;
      if (ext==='stl'||ext==='ply') {
        var geom = loader.parse(data);
        parsed = new THREE.Mesh(geom, new THREE.MeshStandardMaterial({color:0x8899aa,roughness:0.5,metalness:0.2,side:THREE.DoubleSide}));
      } else if (ext==='obj') { parsed = loader.parse(textData);
      } else if (ext==='dae') { var r=loader.parse(textData,''); parsed=r.scene||r;
      } else if (ext==='glb'||ext==='gltf') {
        parsed = await new Promise(function(res,rej){ loader.parse(ext==='gltf'?textData:data,'',function(g){res(g.scene);},rej); });
      } else if (ext==='fbx') { parsed = loader.parse(data); }
      updateStep(s3b, 'done');
      var s4b = addStep('Rendering preview...', 'active');
      setProgress(85, 'Rendering...');
      addToScene(parsed, file.name);
      updateStep(s4b, 'done');
      setProgress(100, 'Complete');
      fill.classList.add('done');
      window.showToast(ext.toUpperCase()+' model loaded successfully!', 'success');
    }
  } catch (err) {
    console.error(err);
    fill.classList.add('error');
    setProgress(100, 'Error: '+err.message);
    window.showToast('Failed: '+err.message, 'warning');
    btn.disabled = false;
  }
};

function addToScene(obj, filename) {
  var doCenter = document.getElementById('opt-center').checked;
  var doShadows = document.getElementById('opt-shadows').checked;
  var grp = (obj.isGroup||obj.isObject3D) ? obj : (function(){var g=new THREE.Group();g.add(obj);return g;})();
  grp.name = filename;
  if (doCenter) {
    var box = new THREE.Box3().setFromObject(grp);
    if (!box.isEmpty()) {
      var size=box.getSize(new THREE.Vector3()); var maxDim=Math.max(size.x,size.y,size.z);
      if (maxDim>0&&(maxDim<0.5||maxDim>500)) grp.scale.multiplyScalar(80/maxDim);
      var box2=new THREE.Box3().setFromObject(grp); var ctr=box2.getCenter(new THREE.Vector3()); var sz=box2.getSize(new THREE.Vector3());
      grp.position.sub(ctr); grp.position.y+=sz.y/2;
    }
  }
  var count=0;
  grp.traverse(function(ch){if(ch.isMesh){count++;if(doShadows){ch.castShadow=true;ch.receiveShadow=true;}}});
  scene.add(grp);
  var bbox=new THREE.Box3().setFromObject(grp);
  if(!bbox.isEmpty()){
    var bc=bbox.getCenter(new THREE.Vector3()); var bs=bbox.getSize(new THREE.Vector3());
    var d=Math.max(bs.x,bs.y,bs.z)*1.8;
    camera.position.set(bc.x+d*0.6,bc.y+d*0.4,bc.z+d*0.6);
    controls.target.copy(bc); controls.minDistance=d*0.05; controls.maxDistance=d*5; controls.update();
  }
  document.getElementById('preview-empty').classList.add('hidden');
  document.getElementById('preview-stats').classList.remove('hidden');
  document.getElementById('stat-elements').textContent = count.toLocaleString()+' elements';
  document.getElementById('stat-format').textContent = filename.split('.').pop().toUpperCase();
}

initPreview();
</script>
</body>
</html>
